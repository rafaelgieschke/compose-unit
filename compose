#!/bin/sh
set -eu

CMD="$1"
shift

DIR=""
for i in $(seq 1 "$#"); do
  OPT="$1"
  shift
  case "$OPT" in
    "-"*)
      set -- "$@" "$OPT";;
    *)
      if test -z "$DIR"; then
        DIR="$OPT"
      else
        set -- "$@" "$OPT"
      fi;;
  esac
done

DIR="$(readlink -f -- "$DIR")"
INSTANCE="$(systemd-escape -p "$DIR")"

if test "$CMD" = "docker"; then
  cd "$DIR"
  COMPOSE_PROJECT_NAME="$INSTANCE" exec docker-compose "$@"
elif test "$CMD" = "journalctl"; then
  exec journalctl -u compose@"$INSTANCE" "$@"
else
  exec systemctl "$CMD" compose@"$INSTANCE" "$@"
fi
